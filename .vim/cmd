curl -X POST "https://secretsmanager.us-west-2.amazonaws.com/" -H "Content-Type: application/x-amz-json-1.1" -H "X-Amz-Target: secretsmanager.GetSecretValue" -H "X-Amz-Security-Token: $(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/) | grep Token | cut -d '"' -f 4)" --aws-sigv4 "aws:amz:us-west-2:secretsmanager" --user "$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/) | grep AccessKeyId | cut -d '"' -f 4):$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/) | grep SecretAccessKey | cut -d '"' -f 4)" -d "{\"SecretId\":\"arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6\"}" | jq -r '.SecretString'

TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token) && ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/) && CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE) && AWS_ACCESS_KEY_ID=$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4) && AWS_SECRET_ACCESS_KEY=$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4) && AWS_SESSION_TOKEN=$(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4) && aws secretsmanager get-secret-value --secret-id "arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6" --region us-west-2 --query 'SecretString' --output text

export TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token) && export ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/) && export CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE) && curl -s -X POST "https://secretsmanager.us-west-2.amazonaws.com/" -H "Content-Type: application/x-amz-json-1.1" -H "X-Amz-Target: secretsmanager.GetSecretValue" -H "X-Amz-Security-Token: $(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4)" --aws-sigv4 "aws:amz:us-west-2:secretsmanager" --user "$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4):$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4)" -d '{"SecretId":"arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6"}'


