curl -X POST "https://secretsmanager.us-west-2.amazonaws.com/" -H "Content-Type: application/x-amz-json-1.1" -H "X-Amz-Target: secretsmanager.GetSecretValue" -H "X-Amz-Security-Token: $(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/) | grep Token | cut -d '"' -f 4)" --aws-sigv4 "aws:amz:us-west-2:secretsmanager" --user "$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/) | grep AccessKeyId | cut -d '"' -f 4):$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/$(curl -s -H "X-aws-ec2-metadata-token: $(curl -X PUT -H 'X-aws-ec2-metadata-token-ttl-seconds: 21600' -sL http://169.254.169.254/latest/api/token)" http://169.254.169.254/latest/meta-data/iam/security-credentials/) | grep SecretAccessKey | cut -d '"' -f 4)" -d "{\"SecretId\":\"arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6\"}" | jq -r '.SecretString'

TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token) && ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/) && CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE) && AWS_ACCESS_KEY_ID=$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4) && AWS_SECRET_ACCESS_KEY=$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4) && AWS_SESSION_TOKEN=$(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4) && aws secretsmanager get-secret-value --secret-id "arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6" --region us-west-2 --query 'SecretString' --output text

export TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token) && export ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/) && export CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE) && curl -s -X POST "https://secretsmanager.us-west-2.amazonaws.com/" -H "Content-Type: application/x-amz-json-1.1" -H "X-Amz-Target: secretsmanager.GetSecretValue" -H "X-Amz-Security-Token: $(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4)" --aws-sigv4 "aws:amz:us-west-2:secretsmanager" --user "$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4):$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4)" -d '{"SecretId":"arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6"}'

export TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token) && export ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/) && export CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE) && curl -s -X POST "https://secretsmanager.us-west-2.amazonaws.com/" -H "Content-Type: application/x-amz-json-1.1" -H "X-Amz-Target: secretsmanager.GetSecretValue" -H "X-Amz-Security-Token: $(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4)" --aws-sigv4 "aws:amz:us-west-2:secretsmanager" --user "$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4):$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4)" -d '{"SecretId":"arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6"}' | grep -o '"SecretString":"[^"]*"' | cut -d':' -f2 | sed 's/^"//;s/"$//'

export TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token) && export ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/) && export CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE) && RESPONSE=$(curl -s -X POST "https://secretsmanager.us-west-2.amazonaws.com/" -H "Content-Type: application/x-amz-json-1.1" -H "X-Amz-Target: secretsmanager.GetSecretValue" -H "X-Amz-Security-Token: $(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4)" --aws-sigv4 "aws:amz:us-west-2:secretsmanager" --user "$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4):$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4)" -d '{"SecretId":"arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6"}') && echo "$RESPONSE" | awk -F'"SecretString":"' '{print $2}' | awk -F'","' '{print $1}' | sed 's/\\"/"/g'


#!/bin/bash

# Get IAM credentials from the metadata service
TOKEN=$(curl -X PUT -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s http://169.254.169.254/latest/api/token)
ROLE=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)
CREDS=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE)

# Extract credentials
ACCESS_KEY=$(echo $CREDS | grep -o '"AccessKeyId" : "[^"]*' | cut -d'"' -f4)
SECRET_KEY=$(echo $CREDS | grep -o '"SecretAccessKey" : "[^"]*' | cut -d'"' -f4)
SESSION_TOKEN=$(echo $CREDS | grep -o '"Token" : "[^"]*' | cut -d'"' -f4)

# AWS request parameters
REGION="us-west-2"
SERVICE="secretsmanager"
ENDPOINT="https://secretsmanager.${REGION}.amazonaws.com/"
SECRET_ID="arn:aws:secretsmanager:us-west-2:123456789000:secret:my_secret-0QN5h6"
HOST="secretsmanager.${REGION}.amazonaws.com"
TARGET="secretsmanager.GetSecretValue"
DATE=$(date -u +"%Y%m%dT%H%M%SZ")
SHORT_DATE=$(date -u +"%Y%m%d")
ALGORITHM="AWS4-HMAC-SHA256"
CANONICAL_URI="/"
CANONICAL_QUERYSTRING=""
PAYLOAD="{\"SecretId\":\"$SECRET_ID\"}"
PAYLOAD_HASH=$(echo -n "$PAYLOAD" | openssl dgst -sha256 | awk '{print $2}')
SIGNED_HEADERS="content-type;host;x-amz-date;x-amz-security-token;x-amz-target"

# Create canonical request
CANONICAL_HEADERS="content-type:application/x-amz-json-1.1\nhost:$HOST\nx-amz-date:$DATE\nx-amz-security-token:$SESSION_TOKEN\nx-amz-target:$TARGET\n"
CANONICAL_REQUEST="POST\n$CANONICAL_URI\n$CANONICAL_QUERYSTRING\n$CANONICAL_HEADERS\n$SIGNED_HEADERS\n$PAYLOAD_HASH"
CANONICAL_REQUEST_HASH=$(echo -n "$CANONICAL_REQUEST" | openssl dgst -sha256 | awk '{print $2}')

# Create string to sign
STRING_TO_SIGN="$ALGORITHM\n$DATE\n$SHORT_DATE/$REGION/$SERVICE/aws4_request\n$CANONICAL_REQUEST_HASH"

# Generate signing key
HMAC() {
  echo -n "$2" | openssl dgst -sha256 -hmac "$1" -binary
}

DATE_KEY=$(HMAC "AWS4$SECRET_KEY" "$SHORT_DATE")
REGION_KEY=$(HMAC "$DATE_KEY" "$REGION")
SERVICE_KEY=$(HMAC "$REGION_KEY" "$SERVICE")
SIGNING_KEY=$(HMAC "$SERVICE_KEY" "aws4_request")

# Compute signature
SIGNATURE=$(echo -n "$STRING_TO_SIGN" | openssl dgst -sha256 -hmac "$SIGNING_KEY" | awk '{print $2}')

# Construct authorization header
AUTHORIZATION_HEADER="$ALGORITHM Credential=$ACCESS_KEY/$SHORT_DATE/$REGION/$SERVICE/aws4_request, SignedHeaders=$SIGNED_HEADERS, Signature=$SIGNATURE"

# Make the request with curl
PASSWORD=$(curl -s -X POST "$ENDPOINT" \
     -H "Content-Type: application/x-amz-json-1.1" \
     -H "X-Amz-Date: $DATE" \
     -H "X-Amz-Security-Token: $SESSION_TOKEN" \
     -H "X-Amz-Target: $TARGET" \
     -H "Authorization: $AUTHORIZATION_HEADER" \
     -d "$PAYLOAD" | sed 's/.*"password":"\([^"]*\)".*/\1/')

echo "Retrieved Password: $PASSWORD"

